<%- include('header_user') %>
<div class="content">
    <h1>Admin Panel</h1>
    
    <!-- Account Lockout Management Section -->
    <div class="admin-section">
        <h2>Account Lockout Management</h2>
        
        <div class="lockout-stats">
            <h3>Lockout Statistics (Read-Only)</h3>
            <div id="lockout-stats-display">
                <button onclick="loadLockoutStats()">Load Statistics</button>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <h2>User Management Logs</h2>
        <div id="user-management-logs-display">
            <button onclick="loadUserManagementLogs()">Load Logs</button>
        </div>
    </div>

    <div class="admin-section">
        <h2>Access Denial Logs</h2>
        <div id="access-denial-logs-display">
            <button onclick="loadAccessDenialLogs()">Load Logs</button>
        </div>
    </div>

    <!-- Database Query Section -->
    <div class="admin-section">
        <h2>Database Query Interface</h2>
        <p>Query (users, friends, posts, login_attempts):</p>
        <form action="admin" method="POST">
            <p><textarea name="query" rows="5" cols="80"><%= locals.query ? locals.query : '' %></textarea></p>
            <p><input type="submit" value="Run Query"/></p>
            <%
                if (locals.errors) {
                    %>
                        <div class="error">
                            <h4>Errors:</h4>
                            <pre><%= locals.errors %></pre>
                        </div>
                    <%
                }
                if (locals.rows) {
                    if (locals.rows.length > 0) {
                        %>
                            <div class="query-results">
                                <h4>Query Results:</h4>
                                <table border="1" style="border-collapse: collapse;">
                                    <%
                                        let index = 0;
                                        for (let row of locals.rows) {
                                            %>
                                                <tr>
                                                    <%
                                                        for (let column of row) {
                                                            if (index == 0) {
                                                                %>
                                                                    <th style="padding: 5px; background-color: #f0f0f0;"><%- column %></th>
                                                                <%
                                                            } else {
                                                                %>
                                                                    <td style="padding: 5px;"><%- column %></td>
                                                                <%
                                                            }
                                                        }
                                                    %>
                                                </tr>
                                            <%
                                            index++;
                                        }
                                    %>
                                </table>
                            </div>
                        <%
                    } else {
                        %>
                            <p>No rows returned.</p>
                        <%
                    }
                }
            %>
        </form>
    </div>
</div>

<script>
async function loadLockoutStats(hours = 24) {
    try {
        const response = await fetch(`/admin/lockout-stats?hours=${hours}`);
        const data = await response.json();
        
        if (data.success) {
            const stats = data.statistics;
            const display = document.getElementById('lockout-stats-display');
            display.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <strong>Total Login Attempts:</strong> ${stats.totalAttempts}
                    </div>
                    <div class="stat-item">
                        <strong>Failed Attempts:</strong> ${stats.failedAttempts}
                    </div>
                    <div class="stat-item">
                        <strong>Successful Attempts:</strong> ${stats.successfulAttempts}
                    </div>
                    <div class="stat-item">
                        <strong>Users Currently Locked:</strong> ${stats.uniqueUsersLocked}
                    </div>
                </div>
                ${stats.topFailedUsernames.length > 0 ? `
                    <div class="top-failed">
                        <h4>Top Failed Login Attempts:</h4>
                        <ul>
                            ${stats.topFailedUsernames.map(u => `<li>${u.username}: ${u.attempts} attempts</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                <button onclick="loadLockoutStats(24)">Last 24 Hours</button>
                <button onclick="loadLockoutStats(168)">Last 7 Days</button>
                <p><em>Admin has read-only access to lockout information. Lockouts will automatically expire after the configured time periods.</em></p>
            `;
        } else {
            document.getElementById('lockout-stats-display').innerHTML = 
                `<div class="error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        document.getElementById('lockout-stats-display').innerHTML = 
            `<div class="error">Failed to load statistics: ${error.message}</div>`;
    }
}

// Load initial statistics
document.addEventListener('DOMContentLoaded', function() {
    loadLockoutStats();
});
</script>

<script>
async function loadUserManagementLogs() {
    try {
        const response = await fetch('/admin/user-management-logs');
        const data = await response.json();
        if (data.success) {
            const logs = data.logs;
            const display = document.getElementById('user-management-logs-display');
            display.innerHTML = `
                <table border="1" style="border-collapse: collapse;">
                    <tr>
                        <th>Time</th>
                        <th>Actor</th>
                        <th>Action</th>
                        <th>Target</th>
                        <th>Role</th>
                    </tr>
                    ${logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${log.actorUsername} (#${log.actorId})</td>
                            <td>${log.action}</td>
                            <td>${log.targetUsername} (#${log.targetId})</td>
                            <td>${log.targetRole}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
        } else {
            document.getElementById('user-management-logs-display').innerHTML = 
                `<div class="error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        document.getElementById('user-management-logs-display').innerHTML = 
            `<div class="error">Failed to load logs: ${error.message}</div>`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadUserManagementLogs();
});
</script>

<script>
async function loadAccessDenialLogs() {
    try {
        const response = await fetch('/admin/access-denial-logs');
        const data = await response.json();
        if (data.success) {
            const logs = data.logs;
            const display = document.getElementById('access-denial-logs-display');
            display.innerHTML = `
                <table border="1" style="border-collapse: collapse;">
                    <tr>
                        <th>Time</th>
                        <th>Actor</th>
                        <th>Reason</th>
                        <th>Route</th>
                        <th>IP</th>
                    </tr>
                    ${logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${log.actorUsername ? `${log.actorUsername} (#${log.actorId})` : 'Guest/Unknown'}</td>
                            <td>${log.reason}</td>
                            <td>${log.route}</td>
                            <td>${log.ipAddress}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
        } else {
            document.getElementById('access-denial-logs-display').innerHTML = 
                `<div class="error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        document.getElementById('access-denial-logs-display').innerHTML = 
            `<div class="error">Failed to load logs: ${error.message}</div>`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadAccessDenialLogs();
});
</script>