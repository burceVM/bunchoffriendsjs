<%- include('header_user') %>
<% if (messages && messages.length) { %>
  <ul>
    <% messages.forEach(function(msg) { %>
      <li><%= msg %></li>
    <% }); %>
  </ul>
<% } %>

<% if (!locals.step || locals.step === 'reauth') { %>
  <!-- Re-authentication step -->
  <h2>Change Password - Authentication Required</h2>
  <p>For your security, please re-enter your current password to proceed with changing your password.</p>
  <% if (locals.reauthTimeout) { %>
    <p><small>This authentication will be valid for <%= reauthTimeout %> minutes.</small></p>
  <% } %>
  
  <form method="POST" action="/reauth-password-change">
    <label>Current Password:</label>
    <input type="password" name="currentPassword" required>
    <br>
    <button type="submit">Authenticate</button>
  </form>

<% } else if (locals.step === 'change') { %>
  <!-- Password change step -->
  <h2>Change Password</h2>
  <p>Authentication successful. Please enter your new password.</p>
  
  <form method="POST" action="/change-password">
    <input type="hidden" name="reauthToken" value="<%= locals.reauthToken %>">
    <label>New Password:</label>
    <input type="password" name="newPassword" required>
    <br>
    <% if (locals.passwordRequirements) { %>
    <div class="password-requirements">
      <h3>Password Requirements:</h3>
      <ul>
        <li>At least <%= passwordRequirements.minLength %> characters long</li>
        <li>At least one uppercase letter (A-Z)</li>
        <li>At least one lowercase letter (a-z)</li>
        <li>At least one number (0-9)</li>
        <li>At least one special character (<%= passwordRequirements.allowedSpecialChars %>)</li>
        <li><strong>Password must be at least 24 hours old before it can be changed</strong></li>
        <li><strong>Cannot reuse any of your last 5 passwords</strong></li>
      </ul>
    </div>
    <% } %>
    <button type="submit">Change Password</button>
  </form>

<% } else if (locals.step === 'success') { %>
  <!-- Success step -->
  <h2>Password Changed Successfully</h2>
  <p>Your password has been changed successfully.</p>
  <a href="/home">Return to Home</a>

<% } %>

<script src="/static/password-validator.js"></script>